os: linux
dist: bionic
language: python
before_install:
- openssl aes-256-cbc -K $encrypted_bdba505e7122_key -iv $encrypted_bdba505e7122_iv
  -in oci_data.tar.enc -out $TRAVIS_BUILD_DIR/oci_data.tar -d
- tar -xvf $TRAVIS_BUILD_DIR/oci_data.tar -C $TRAVIS_BUILD_DIR/
- rm -rf ~/.ansible
install:
- pip install -r tests/requirements.txt
- pip install -r requirements-dev.txt
- pip install -r requirements.txt
stages:
- prepare
- cluster_tests
- instance_orchestration_tests
- instance_configurer_tests
- vcn_tests
if: commit_message =~ ^.*\[ci\].*$
jobs:
  include:
  - stage: prepare
    python: '3.6'
    script: &1
    - python setup.py check -rms
    - flake8
  - stage: prepare
    python: '3.7'
    script: *1
  - stage: prepare
    python: '3.8'
    script: *1
  - stage: cluster_tests
    python: '3.6'
    script:
    - travis_wait pytest -s -v tests/test_cluster_stack.py
    - travis_wait pytest -s -v tests/test_cluster_orchestrator.py
  - stage: instance_orchestration_tests
    python: '3.6'
    script: travis_wait pytest -s -v tests/test_instance_orchestrator.py
  - stage: instance_orchestration_tests
    python: '3.7'
    script: travis_wait pytest -s -v tests/test_instance_orchestrator.py
  - stage: instance_orchestration_tests
    python: '3.8'
    script: travis_wait pytest -s -v tests/test_instance_orchestrator.py
  - stage: instance_configurer_tests
    python: '3.6'
    before_script: &2
    - mkdir $TRAVIS_BUILD_DIR/.ssh/
    - ssh-keygen -t rsa -b 4096 -N "" -f $TRAVIS_BUILD_DIR/.ssh/oci_id_rsa
    env:
      - OCI_INSTANCE_SSH_KEY=$TRAVIS_BUILD_DIR/.ssh/oci_id_rsa
      - ANSIBLE_HOST_KEY_CHECKING=False
    script: travis_wait pytest -s -v tests/test_instance_configurer.py
  - stage: instance_configurer_tests
    python: '3.7'
    before_script: *2
    env:
      - OCI_INSTANCE_SSH_KEY=$TRAVIS_BUILD_DIR/.ssh/oci_id_rsa
      - ANSIBLE_HOST_KEY_CHECKING=False
    script: travis_wait pytest -s -v tests/test_instance_configurer.py
  - stage: instance_configurer_tests
    python: '3.8'
    before_script: *2
    env:
      - OCI_INSTANCE_SSH_KEY=$TRAVIS_BUILD_DIR/.ssh/oci_id_rsa
      - ANSIBLE_HOST_KEY_CHECKING=False
    script: travis_wait pytest -s -v tests/test_instance_configurer.py
  - stage: vcn_tests
    python: '3.6'
    script: travis_wait pytest -s -v tests/test_vcn_*.py
  - stage: vcn_tests
    python: '3.7'
    script: travis_wait pytest -s -v tests/test_vcn_*.py
  - stage: vcn_tests
    python: '3.8'
    script: travis_wait pytest -s -v tests/test_vcn_*.py
  - stage: deploy
    python: '3.7'
    script: python setup.py sdist bdist_wheel
    deploy:
      skip_cleanup: true
      skip_existing: true
      distributions: sdist bdist_wheel
      provider: pypi
      user: __token__
      password:
        secure: R4WWdmEXt5RIKKblang9srOKh8ZT17dxOddoJeKhlvDi0mhxlCAZaw50zA8RcuSWI1iLgmqP3piVw6YwQmbewCGuQh4NiTjTBLh3Dm398nazbDCOBdCCtI46PJC6Ng54UntuDLgyLVjwmvEM0UK8tnrYpUH9YE+KHsoaQnE3lYHez2kmXVt1uuBnXJurOuVo03vFfixjNL+obFZ3IBJe9E/h9GBIg13qTRt6nU3xSDbw4FgUKMoXfLYZnu2/Kb/SCcENlVFx2BLxUtCyTmGpmLf4h7mbhaZlvgf8P46HM5iU9hvbiFlQ5UojJQmJdlzK2XP+2+4bLMHGyn/mhmA9R7IUVmxpo0SKO3ZZk0D68j5fiipL0DdqLMaSGvB+JEiIB5F+K3HjTcZ6r+iKjM6icXA9WZ2SDXybMxz3ad95KJn0A+sS+s/Z4vho5vWAWDpO9TYNIJxcZDfdKbX/wkDkiVGJhoJPVAhSAP/Cr0dYnbKtyGT5Re6YYbztfkuHVX7/pH1O67zmzGc6dUcCkJX0PjHmOp5GrVJDM21MGLjP0G1XgzQxy9qQxucBtNfMQB4AMDbHbTBflzVa8T7cFWRt8iruQlPtzwHqGqF3sgSlsZ5tyjOB5oIO2dC9e2bzYe94rBVZi8TU9k6mMwaMUmWk/AOvWDs8VLlYaRPjFhqYgWo=
      on:
        tags: true
        branch: master
        python: '3.7'
env:
  global:
  - OCI_TEST_ID="$TRAVIS_JOB_ID-$TRAVIS_JOB_NUMBER"
  - OCI_CONFIG_DIR="$TRAVIS_BUILD_DIR/.oci"
  - OCI_CONFIG_PATH="$OCI_CONFIG_DIR/config"
  - OCI_KEY_FILE="$OCI_CONFIG_DIR/test_api_info"
  - secure: Pck6ytGvxHS/UZK7oXw9kPDoouH8MB5uy5QoB0bb3BWGeUiLsWyMPqpVbkib0ZCduXVHzgbuHaWwiUnY8plf7yZ+KSJzD57Xp4oMrfSOyqCvhQUY2U+hMu8jAupcxlSgCS7EbPF5vsuyUWWyIHvCwAtoRzHc1RBek4GsIn+esbicUkftnyyDNIW48FrG+PoyDDNOHnWXMr9Sa031MZljQIoLbsuoyifNoURiKi3Hx6pymwwdRvVVGiCXzUNctnLJDpIhdImu44vdjKppAbib1cqhMyBX/JFpzpS8qPN7DpmjfmuNzuqKtOdk7Fp6oNNu7Q76299Bq0/7MwF1yNwcdU4VctYeQPKKVTF7NgkE4yKHBhS1TmblbSZ/eImDQ1qaEQk2ll/iZKblIoUwTaZbuVgVlR2EaIexdiYTwO/JveLq126KlgvJRyoLPIgADTCsO5X9fb5Cib5SEXyg3APVtqvR0CdsCgLvLQSmocNxI0c3GsxxLmUmjfrRQsbAUJd4jVisqsIOiPbifB1IbfZLW1muWpYR1QF/MAis7Ak3aHSZw8gHiQ4ycBFjyTtn02z4D3YQ43SNdDEm4UKU35/DATjw+QgDPUeSsXne6xaM6TR8ZWmrJIq34md0e+YYtkkD/1qEl0nzkl9eV/swRQF5BZr5gkfiqs3px/VzaEbFsTo=
